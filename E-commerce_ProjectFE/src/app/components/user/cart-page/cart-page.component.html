<div class="cart-container">
  
  <div class="my-orders-section">
    <button class="my-orders-btn" (click)="navigateToOrders()">
      <i class="fas fa-list-alt"></i> My Orders
    </button>
  </div>

  <div class="cart-content">
    
    <div class="cart-items-section">
      <div class="cart-header">
        <h2>Shopping Cart</h2>
        <span class="item-count">{{ totalItemsCount }} Items</span>
      </div>

      
      <div *ngIf="isLoading" class="loading-state">
        <p>Loading cart items...</p>
      </div>

      
      <div class="column-headers" *ngIf="!isLoading && cartItems.length > 0">
        <div class="product-header">PRODUCT DETAILS</div>
        <div class="quantity-header">QUANTITY</div>
        <div class="price-header">PRICE</div>
        <div class="total-header">TOTAL</div>
      </div>

      
      <div class="cart-items-list" *ngIf="!isLoading">
        <div *ngIf="cartItems && cartItems.length > 0; else emptyCart">
          <div *ngFor="let item of cartItems" class="cart-item">
            
            <div class="product-details">
              <img [src]="item.product.productImageURL" [alt]="item.product.productName" class="product-image">
              <div class="product-info">
                <h3>{{ item.product.productName }}</h3>
                <p class="product-category">{{ item.product.productDescription }}</p>
            
                
                <div class="product-meta">
                  <div class="id-badges">
                    <span class="id-badge cart-id">
                      <i class="fas fa-shopping-cart"></i>
                      Cart ID : {{ item.cartItemId }}
                    </span>
                    <span class="id-badge product-id">
                      <i class="fas fa-box"></i>
                      Product ID : {{ item.product.productId }}
                    </span>
                  </div>
                </div>
            
                <button class="remove-btn" (click)="deleteCartItem(item.cartItemId)">
                  <i class="fas fa-trash-alt"></i> Remove
                </button>
              </div>
            </div>
            
            <div class="quantity-controls">
              <button class="qty-btn minus" (click)="decreaseQuantity(item)">âˆ’</button>
              <span class="qty-display">{{ item.productQuantity }}</span>
              <button class="qty-btn plus" (click)="increaseQuantity(item)">+</button>
            </div>
            <div class="item-price">{{ item.product.productPrice | currency:'INR':'symbol':'1.2-2' }}</div>
            <div class="item-total">{{ item.totalPrice | currency:'INR':'symbol':'1.2-2' }}</div>
            <div class="item-selection">
              <label>
                <input type="checkbox" (change)="toggleSelection(item, $event)">
                Select
              </label>
            </div>
          </div>
        </div>
      </div>

      
      <ng-template #emptyCart>
        <div class="empty-cart-message">
          <p>Your cart is empty ðŸ˜•</p>
        </div>
      </ng-template>

      
      <div class="continue-shopping" *ngIf="!isLoading && cartItems.length > 0">
        <button class="continue-btn" (click)="goToHome()">
          <i class="fas fa-arrow-left" ></i> Continue Shopping
        </button>
      </div>
    </div>

    
    <div class="order-summary" *ngIf="!isLoading && cartItems.length > 0">
      <h3>Order Summary</h3>
      
      <div class="summary-row">
        <span>ITEMS {{ selectedItemsCount > 0 ? selectedItemsCount : totalItemsCount }}</span>
        <span>{{ (selectedItemsCount > 0 ? selectedItemsTotal : totalPrice) | currency:'INR':'symbol':'1.2-2' }}</span>
      </div>

      <div class="summary-row">
        <span>SHIPPING</span>
        <span>{{ shippingCost | currency:'INR':'symbol':'1.2-2' }}</span>
      </div>

      
      <div class="address-section" *ngIf="selectedItems.length > 0">
        <div class="summary-row">
          <span>SHIPPING ADDRESS</span>
          <button class="add-new-btn" (click)="toggleAddAddressForm()" type="button">
            <i class="fas fa-plus"></i> Add New
          </button>
        </div>
        
                 <!-- Address Selection Dropdown -->
         <div class="address-dropdown" *ngIf="!showAddAddressForm">
           <select class="form-control" [(ngModel)]="selectedAddressId" (change)="onAddressChange()">
             <option value="">-- Select an address --</option>
             <option *ngFor="let address of userAddresses" [value]="address.addressId">
               {{ address.fullAddress }}
             </option>
           </select>
         </div>

        <!-- Add New Address Form -->
        <div class="add-form-section" *ngIf="showAddAddressForm">
          <div class="form-group">
            <input 
              type="text" 
              class="form-input" 
              [(ngModel)]="newAddress" 
              placeholder="Enter complete address" 
            />
          </div>
          <div class="form-actions">
            <button class="form-submit-btn" (click)="addNewAddress()">
              <i class="fas fa-plus"></i> Add Address
            </button>
            <button class="form-cancel-btn" (click)="toggleAddAddressForm()">
              <i class="fas fa-times"></i> Cancel
            </button>
          </div>
        </div>
      </div>

      <div class="shipping-section">
        <div class="summary-row">
          <span>SHIPPING</span>
        </div>
        <div class="shipping-option">
          <select class="shipping-select" (change)="onShippingChange($event)">
            <option value="5">Standard Delivery - â‚¹5.00</option>
            <option value="10">Express Delivery - â‚¹10.00</option>
            <option value="15">Overnight Delivery - â‚¹15.00</option>
          </select>
        </div>
      </div>

      
             <!-- Payment Section - Only show if address is selected -->
       <div class="payment-section" *ngIf="selectedAddressId">
         <h4>Payment Options</h4>

         <div class="payment-options">
           <div class="payment-option">
             <input type="radio" id="payNow" name="payment" value="PAY_NOW" 
                    [(ngModel)]="paymentOption" (change)="selectPaymentOption('PAY_NOW')">
             <label for="payNow">Pay Now</label>
           </div>
           <div class="payment-option">
             <input type="radio" id="cod" name="payment" value="CASH_ON_DELIVERY" 
                    [(ngModel)]="paymentOption" (change)="selectPaymentOption('CASH_ON_DELIVERY')">
             <label for="cod">Cash on Delivery</label>
           </div>
         </div>

        <div *ngIf="paymentOption === 'PAY_NOW'" class="payment-method-selection">
          <div class="form-group">
            <label class="form-label">Payment Method:</label>
            <select class="payment-method-dropdown" 
                    [(ngModel)]="selectedPaymentMethod" 
                    (change)="onPaymentMethodChange()">
              <option value="">Select payment method</option>
              <option *ngFor="let method of paymentEnums" [value]="method">
                {{ method }}
              </option>
            </select>
          </div>

            <!-- Show saved payment methods for selected payment type -->
            <div *ngIf="selectedPaymentMethod && getFilteredSavedPayments().length > 0" class="saved-payments-section">
              <div class="saved-payments-header">
                <h5>Saved {{ selectedPaymentMethod }} Payment Methods</h5>
                <button class="add-new-payment-btn" (click)="toggleAddNewPayment()">
                  <i class="fas fa-plus"></i> Add New
                </button>
              </div>

              <div class="form-group">
                <select class="saved-payment-dropdown" 
                        [(ngModel)]="selectedSavedPayment" 
                        (change)="onSavedPaymentSelect()">
                  <option [ngValue]="null">Select {{ selectedPaymentMethod }} payment</option>
                  <option *ngFor="let payment of getFilteredSavedPayments()" [ngValue]="payment">
                    {{ maskAccountDetails(payment.accountDetails) }}
                  </option>
                </select>
              </div>
            </div>

            <div *ngIf="selectedPaymentMethod && getFilteredSavedPayments().length === 0 && !showAddNewPayment" class="manual-entry-section">
              <h6>No saved {{ selectedPaymentMethod }} payments found</h6>
              <div class="form-group">
                <label class="form-label">{{ getAccountDetailsLabel() }}:</label>
                <input type="text" 
                       class="account-details-input"
                       [(ngModel)]="selectedAccountDetails"
                       [placeholder]="getAccountDetailsPlaceholder()">
                <small class="payment-help-text">This payment will not be saved. Click "Add New" to save for future use.</small>
              </div>
              <button class="add-new-payment-btn" (click)="toggleAddNewPayment()">
                <i class="fas fa-plus"></i> Add New Payment
              </button>
            </div>

            <div *ngIf="selectedPaymentMethod && getFilteredSavedPayments().length > 0 && !selectedSavedPayment && !showAddNewPayment" class="manual-entry-section">
              <h6>Or enter payment details manually</h6>
              <div class="form-group">
                <label class="form-label">{{ getAccountDetailsLabel() }}:</label>
                <input type="text" 
                       class="account-details-input"
                       [(ngModel)]="selectedAccountDetails"
                       [placeholder]="getAccountDetailsPlaceholder()">
                <small class="payment-help-text">This payment will not be saved. Click "Add New" to save for future use.</small>
              </div>
            </div>

          <div *ngIf="showAddNewPayment" class="add-new-payment-form">
            <h5 class="form-title">Add New Payment Method</h5>
            <div class="form-group">
              <label class="form-label">Payment Method:</label>
              <select class="payment-method-select" [(ngModel)]="newPaymentMethod" required>
                <option value="" disabled>Select payment method</option>
                <option *ngFor="let method of paymentEnums" [value]="method">
                  {{ method }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Account Details:</label>
              <input type="text" 
                     class="account-details-input"
                     [(ngModel)]="newAccountDetails"
                     [placeholder]="getNewPaymentPlaceholder()">
            </div>
            <div class="payment-form-actions">
              <button class="save-payment-btn" (click)="addNewPaymentMethod()">
                <i class="fas fa-save"></i> Add Payment
              </button>
              <button class="cancel-payment-btn" (click)="cancelAddNewPayment()">
                <i class="fas fa-times"></i> Cancel
              </button>
            </div>
          </div>

        </div>
      </div>

      <div class="total-section">
        <div class="summary-row total-row">
          <span>TOTAL COST</span>
          <span>{{ (selectedItemsCount > 0 ? getFinalTotal() : getAllItemsTotal()) | currency:'INR':'symbol':'1.2-2' }}</span>
        </div>
      </div>
      <button class="checkout-btn" 
              (click)="placeOrder()" 
              [disabled]="!isCheckoutEnabled()">
        CHECKOUT
      </button>
    </div>
  </div>
</div>